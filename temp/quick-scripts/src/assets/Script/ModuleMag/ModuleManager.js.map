{"version":3,"sources":["assets/Script/ModuleMag/ModuleManager.js"],"names":["Module","require","ModuleConst","JS_LOG","arg","cc","log","Class","Component","properties","asset1","type","Asset","asset2","onLoad","_ModuleCom","getComponent","_unpackage","_HotUIHelper","_nativeRootPath","jsb","absPath1","fileUtils","fullPathForFilename","nativeUrl","replace","absPath2","testLen","length","i","substring","getDefaultResourceRootPath","initCom","args","useHotUpdate","_useHotUpdate","_lastReq_VersionInfoTime","_detectNewVersionInterval","modules","_local_data_key","localVersionConfigKey","versionData","sys","localStorage","getItem","createDefaultVersionData","JSON","parse","_local_Version","_romoteVersion","execUnpackage","onComplate","getNativePath","reqLoopVersionInfo","_reqLoopHandler","reqVersionInfo","schedule","setLocalAbVersion","verObj","localMap","abName","verStr","resVersion","setItem","stringify","get_LocalVersion","get_RomoteVersion","ret","clientMin","hotUpdateAllModule","callback","isShowHotDetectAlert","checkNewVersionShow","hotUpdateMultiModule","Object","keys","checkNewVersionHide","moduleNameArr","isNeedReq_versionInfo","_doHotUpdateMulti","comVersion","_Gloabal","Client_Version","showAlertClientTooOld","getDependModule","need_Update","need_Restart","onAllModuleHotFinish","setTimeout","game","restart","needUpdateNames","preloadDir","sequenceMis","hideUpdating","curMis","idx","onExec","curMisIdx","totalMis","moduleObj","preloadModule","finish","total","item","onProgress","items","showUpdating","showHotAlert","moduleName","retTemp","_hotUpdateModule","hot_ret","haveNewVer","needRestart","push","names","h","rms","n_1","name","priority","depends","depend","j","n_2","minfos","values","sort","a","b","local_Ver","romoteVer","loadVerFunc","mObj","ver","cb","loadAB","showVer","init","getBundle","_abObj","getModule","addModule","module","removeModule","releaseAB","reqVersionImmediately","curTime","Date","getTime","_httpReqHandler","abort","verUrl","hotUrl","createUUID","makeXMLHttp","url","_args","httpData","retData","remoteMap","needSave"],"mappings":"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","sourceRoot":"/","sourcesContent":["\n\n// ModuleManager\nlet Module = require(\"Module\") \nlet ModuleConst = require(\"ModuleConst\")\n\nlet JS_LOG = function(...arg){ \n    cc.log(\"[ModuleManager]\",...arg) ; \n}\n\ncc.Class({\n    \n    extends: cc.Component,\n    properties: {  \n        // 获取包内路径; 需要分别绑定 resources 和 Texture 下资源文件;\n        asset1: { default: null, type: cc.Asset }, \n        asset2: { default: null, type: cc.Asset },\n    },\n\n    onLoad(){\n        this._ModuleCom     = this.getComponent(\"ModuleCom\")\n        this._unpackage     = this.getComponent(\"UnpackageHelper\")\n        this._HotUIHelper   = this.getComponent(\"HotUIHelper\") \n\n        // jsb.fileUtils.getDefaultResourceRootPath()\n        this._nativeRootPath = \"\"   // native ab根路径 , 以 / 结尾\n        if(typeof(jsb)!=\"undefined\"){\n            let absPath1 = jsb.fileUtils.fullPathForFilename(this.asset1.nativeUrl).replace(\"//\",\"/\")\n            let absPath2 = jsb.fileUtils.fullPathForFilename(this.asset2.nativeUrl).replace(\"//\",\"/\")\n            let testLen = absPath1.length>absPath2.length? absPath2.length : absPath1.length \n            for(let i=0;i<testLen;i++){\n                if(absPath1[i] != absPath2[i]){\n                    this._nativeRootPath = absPath1.substring(0, i)\n                    break\n                }\n            } \n            cc.log(\"default_path_:\", jsb.fileUtils.getDefaultResourceRootPath()); \n            cc.log(\"absFile_path_2:\", this._nativeRootPath )\n        }\n    },\n\n    initCom(args){\n        let { useHotUpdate } = args \n        this._unpackage.initCom(args)\n        \n        this._useHotUpdate = useHotUpdate \n        this._lastReq_VersionInfoTime = 0 //(new Date()).getTime()  // 最后一次检测版本时间\n        this._detectNewVersionInterval = 30  // 自动检测版本间隔\n\n        this.modules = {}\n\n        this._local_data_key = ModuleConst.localVersionConfigKey //\"_local_gameVersionData1\"\n        let versionData = cc.sys.localStorage.getItem(this._local_data_key)\n        if(!versionData){ \n            versionData = this.createDefaultVersionData() \n        }else {\n            versionData = JSON.parse(versionData)\n        } \n        this._local_Version = versionData\n\n        this._romoteVersion = this.createDefaultVersionData()\n        \n    },\n\n    execUnpackage(onComplate){\n        this._unpackage.execUnpackage(onComplate)\n    },\n\n    getNativePath(){\n        return this._nativeRootPath\n    },\n    reqLoopVersionInfo(){\n        if(this._useHotUpdate){\n            if(this._reqLoopHandler){ return }\n            this._reqLoopHandler = ()=>{\n                this.reqVersionInfo()\n            }\n            this.schedule(this._reqLoopHandler, this._detectNewVersionInterval)\n        }\n    },\n\n    // 更新AB版本号 , 新包安装解压资源后覆盖版本号\n    setLocalAbVersion(verObj){\n\n        let localMap = this._local_Version\n        for(let abName in verObj){\n            let verStr = verObj[abName]\n\n            if(!localMap.modules[abName]){   // 运营中新增模块\n                localMap.modules[abName] = {}\n            }\n            localMap.modules[abName].resVersion = verStr \n        } \n\n        cc.sys.localStorage.setItem(this._local_data_key, JSON.stringify(this._local_Version))\n    },\n\n    get_LocalVersion(){\n        return this._local_Version\n    },\n\n    get_RomoteVersion(){\n        return this._romoteVersion\n    },\n\n    createDefaultVersionData(){\n        let ret = {\n            clientMin : \"1.0.0\" , \n            modules : {}\n        }   \n        return ret \n    },\n    \n    // 更新所有模块\n    hotUpdateAllModule(callback, isShowHotDetectAlert){\n        if(!this._useHotUpdate){\n            callback && callback();\n            return false;\n        }\n\n        // 显示正在检测更新提示\n        if(isShowHotDetectAlert){\n            this._HotUIHelper.checkNewVersionShow()\n        }\n\n        return this.hotUpdateMultiModule(Object.keys(this._romoteVersion.modules), ()=>{ \n            this._HotUIHelper.checkNewVersionHide()\n            callback()\n        })\n\n    },\n\n    // 置顶更新模块\n    hotUpdateMultiModule(moduleNameArr, callback){\n        if(this.isNeedReq_versionInfo()){\n            this.reqVersionInfo(()=>{\n                this._doHotUpdateMulti(moduleNameArr, callback)\n            })\n        }else {\n            this._doHotUpdateMulti(moduleNameArr, callback)\n        } \n    },\n    _doHotUpdateMulti(moduleNameArr, callback){\n        if(!this._useHotUpdate){\n            callback && callback();\n            return false;\n        }\n\n        // 大版本太旧\n        if(-1 == this._ModuleCom.comVersion(_Gloabal.Client_Version, this._romoteVersion.clientMin )){\n            this._HotUIHelper.showAlertClientTooOld()\n            return \n        }\n        JS_LOG(\"moduleName_ori:\", JSON.stringify(moduleNameArr) )\n        moduleNameArr = this.getDependModule(moduleNameArr)\n        JS_LOG(\"moduleName_dep:\", JSON.stringify(moduleNameArr) )\n\n        // isShowHotUI \n        let need_Update  = false \n        let need_Restart = false \n\n        // 所有module更新完成\n        let onAllModuleHotFinish = ()=>{\n            JS_LOG(\"hot_update_-AllHot_Finish\")\n            cc.sys.localStorage.setItem(this._local_data_key, JSON.stringify(this._local_Version))\n            if(need_Restart){\n                // this.scheduleOnce(()=>{ \n                //     // cc.sys.restartVM() \n                //     cc.game.restart();\n                // }, 0.1)\n                setTimeout(() => { \n                    cc.game.restart();\n                }, 100);\n            }else {\n                callback && callback();\n            }\n        }\n\n        // 下载 assets bundle 资源\n        let needUpdateNames = []\n        let preloadDir = ()=>{\n            this._ModuleCom.sequenceMis(needUpdateNames, ()=>{\n                JS_LOG(\"hot_update_-allPreloadFinish\")\n                // 所有任务完成\n                this._HotUIHelper.hideUpdating(onAllModuleHotFinish)\n\n            }, (curMis, idx, onExec)=>{ \n                // 每个预加载任务\n                let curMisIdx = idx+1\n                let totalMis = needUpdateNames.length\n                let moduleObj = this.modules[needUpdateNames[idx]]\n                moduleObj.preloadModule((finish, total, item)=>{\n\n                    // JS_LOG(\"hot_update_-onProgress_info_:\", curMisIdx, finish, total, item.url )\n                    this._HotUIHelper.onProgress( curMisIdx, totalMis, finish, total)\n                }, (items)=>{\n\n                    JS_LOG(\"hot_update_-preloadOK_:\", needUpdateNames[idx] )\n                    onExec()\n                })\n            })\n        }\n\n\n        // ------------------------------------------- 顺序下载配置 \n        this._ModuleCom.sequenceMis(moduleNameArr, ()=>{\n            // 所有配置下载完成\n            if(need_Update){\n                this._HotUIHelper.showUpdating(1, needUpdateNames.length)\n                this._HotUIHelper.showHotAlert(need_Restart, ()=>{\n                    preloadDir()\n                })\n            }else {\n                onAllModuleHotFinish()\n            }\n            \n        }, (curMis, idx, onExec)=>{ \n            // 每个预加载任务\n            let moduleName = moduleNameArr[idx]\n            let retTemp = {}\n            retTemp = this._hotUpdateModule(moduleName, (hot_ret)=>{\n                let {haveNewVer, needRestart} = hot_ret\n                if(haveNewVer) { \n                    need_Update = true \n                    needUpdateNames.push(moduleName)\n                }\n                if(needRestart) { need_Restart = true }\n                onExec()\n            }) \n            // ------------------------------------------ \n        })\n        \n    },\n\n    // 获取依赖模块, 并排序\n    getDependModule(names, h){\n        h = h || 1\n        let rms = this._romoteVersion.modules \n        let ret = {}\n        for(let idx in names){\n            let n_1 = names[idx]\n            ret[n_1] = { name:n_1, priority:rms[n_1].priority}\n\n            let depends = this.getDependModule(rms[n_1].depend || [], h+1)\n            for(let j in depends){\n                let n_2 = depends[j]\n                ret[n_2] = { name:n_2, priority:rms[n_2].priority}\n            }\n        }\n        //排序, 优先级高的先更新 \n        if(h==1){\n            let minfos = Object.values(ret)\n            minfos.sort(function(a,b){  \n                if(a.priority > b.priority){ return -1}\n                return 1;\n            })\n            ret = {}\n            for(let idx in  minfos){\n                ret[minfos[idx].name] = 1\n            }\n        }\n\n        return Object.keys(ret)\n    },\n\n    // 更新到最新版本 \n    _hotUpdateModule(moduleName, callback){\n        if(!this._useHotUpdate){\n            let ret = { haveNewVer:false, needRestart:false };\n            callback && callback(ret);\n            return ret;\n        }\n\n        let local_Ver = this._local_Version.modules[moduleName].resVersion\n        let romoteVer = this._romoteVersion.modules[moduleName].resVersion\n        let moduleObj = this.modules[moduleName]\n\n        JS_LOG(\"version_info_data_-local:\", JSON.stringify(this._local_Version) )\n        JS_LOG(\"version_info_data_-remote:\", JSON.stringify(this._romoteVersion) )\n\n        let ret = { haveNewVer: (local_Ver != romoteVer), needRestart:false }\n\n        let loadVerFunc = (mObj, ver, cb)=>{\n            mObj.loadAB(()=>{\n                if(local_Ver != romoteVer){\n                    this._local_Version.modules[moduleName].resVersion = romoteVer\n                    this._local_Version.modules[moduleName].showVer = this._romoteVersion.modules[moduleName].showVer\n                    \n                }\n                cb && cb();\n            }, ver)\n        }\n\n        if(!moduleObj){\n            // 未加载过, 更新后不需要重启\n            moduleObj = new Module()\n            loadVerFunc( moduleObj.init(moduleName), romoteVer, ()=>{\n                this.modules[moduleName] = moduleObj\n                callback && callback(ret);\n            }) \n\n        }else {\n            // 已加载, 若有更新则更新后重启\n            if(local_Ver == romoteVer){\n                callback && callback(ret);\n            }else {\n                ret.needRestart = true \n                loadVerFunc(moduleObj, romoteVer, ()=>{\n                    callback && callback(ret);\n                })\n            }\n        }\n        return ret\n\n    },\n    // ------------------------------------------------------------\n    getBundle(moduleName){\n        // JS_LOG(\"ModuleMag_getbundle__:\", moduleName)\n        return this.modules[moduleName]._abObj\n    },\n\n    getModule(moduleName){\n        return this.modules[moduleName]\n    },\n\n    addModule(moduleName, cb){\n        let module = this.modules[moduleName]\n        JS_LOG(\"module_mag-addMOdule:\", moduleName, module )\n        if(module){ \n            cb(module)\n            return module\n        }\n        this.removeModule(moduleName)\n\n        JS_LOG(\"load_AB____:\", moduleName)\n\n        let moduleObj = new Module()\n        moduleObj.init(moduleName, this._useHotUpdate).loadAB(()=>{\n            this.modules[moduleName] = moduleObj\n            cb && cb(moduleObj)\n        })\n\n    },\n\n    removeModule(moduleName){\n        let moduleObj = this.modules[moduleName]\n        if(!moduleObj){ return }\n        moduleObj.releaseAB()\n        delete this.modules[moduleName];\n    },\n\n    //------------------------------------------------------------------->> 查询新版本\n    isNeedReq_versionInfo(){\n        if(ModuleConst.reqVersionImmediately){\n            return true \n        }\n\n        let curTime = (new Date()).getTime()  \n        JS_LOG(\"is_need_req_ver_:\", curTime , this._lastReq_VersionInfoTime)\n        if(curTime - this._lastReq_VersionInfoTime > this._detectNewVersionInterval*1000){ \n            return true \n        } \n        return false\n    },\n\n    reqVersionInfo(callback){\n        if(!this._useHotUpdate){\n            callback && callback();\n            return false;\n        }\n        if(this._httpReqHandler){\n            this._httpReqHandler.abort()\n        }\n        let verUrl = ModuleConst.hotUrl + \"verconfig.json\" + \"?renew=\" + this._ModuleCom.createUUID() \n        JS_LOG(\"req_version_url_:\", verUrl)\n\n        this._httpReqHandler = this._ModuleCom.makeXMLHttp({url: verUrl, callback:(_args)=>{\n\n            let httpData = _args.retData\n            if(!httpData){\n                return ;\n            }\n            this._httpReqHandler = null\n            this._romoteVersion = httpData\n\n            JS_LOG(\"onReqVersion_Info_:\", JSON.stringify(httpData) )\n            let localMap = this._local_Version\n            let remoteMap = httpData\n            let needSave = false \n\n            for(let moduleName in remoteMap.modules){ \n\n                if(!localMap.modules[moduleName]){   // 运营中新增模块\n                    localMap.modules[moduleName] = {}\n                }\n                if(!localMap.modules[moduleName].showVer){\n                    needSave = true \n                    localMap.modules[moduleName].showVer = (remoteMap.modules[moduleName].showVer)\n                }\n            }\n\n            if(needSave){\n                cc.sys.localStorage.setItem(this._local_data_key, JSON.stringify(this._local_Version))\n            }\n\n            this._lastReq_VersionInfoTime = (new Date()).getTime()\n            callback && callback();\n        }}) \n        \n    },\n    \n\n    //-------------------------------------------------------------------<< 查询新版本\n\n});\n"]}