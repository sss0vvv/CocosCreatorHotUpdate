{"version":3,"sources":["assets/Script/ModuleMag/Module.js"],"names":["JS_LOG","arg","cc","log","ModuleConst","require","Class","Component","properties","ctor","init","ABName","useHotUpdate","_ABName","_useHotUpdate","getABObj","_abObj","getModuleName","loadAB","cb","version","loadArg","isValid","abUrl","hotUrl","assetManager","loadBundle","err","bundle","JSON","stringify","scheduleOnce","preloadModule","onProgress","onComplete","is_Valid","autoAtlas","resMap","_config","assetInfos","_map","idx","item","path","nativeVer","urll","utils","getUrlWithUuid","uuid","__nativeName__","nativeExt","extname","isNative","push","extNum","length","finishNum","is_2Valid","preloadAutoAtlas","preloadAny","__requestType__","type","name","finish","total","error","items","preloadDir","releaseAB","unscheduleAllCallbacks","removeBundle"],"mappings":"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","sourceRoot":"/","sourcesContent":["\n\nlet JS_LOG = function(...arg){ \n    cc.log(\"[Module]\",...arg) ; \n}\nlet ModuleConst = require(\"ModuleConst\")\n\ncc.Class({\n    \n    extends: cc.Component,\n    properties: { \n\n    },\n\n    ctor(){\n        JS_LOG(\"module_ctor_\")\n    },\n    init(ABName, useHotUpdate){\n        JS_LOG(\"module_init\")\n        \n        this._ABName = ABName\n        this._useHotUpdate = useHotUpdate\n        return this\n    },\n\n    getABObj(){\n        return this._abObj \n    },\n    getModuleName(){\n        return this._ABName\n    },\n\n    loadAB(cb, version){\n        // {version: 'fbc07'},\n        let loadArg = {}\n        if(version){\n            loadArg.version = version\n        }\n        let isValid = true \n        let abUrl = this._ABName \n\n        if(this._useHotUpdate){\n            // 如果希望使用creator构建时填的资源服务器地址,将下面这行代码注释掉即可.\n            abUrl = ModuleConst.hotUrl + \"remote/\" + this._ABName\n        }\n        JS_LOG(\"loadAB_:\", this._ABName, abUrl  )\n        cc.assetManager.loadBundle(abUrl,  loadArg, (err, bundle)=> {\n            if(!isValid){ return } ;  isValid = false ;\n            \n            if(!err){\n                JS_LOG(\"loadAB_OK_:\", this._ABName )\n                this._abObj = bundle \n\n                cb()\n            }else {\n                JS_LOG(\"load_ab_Err_:\", this._ABName, JSON.stringify(err)) \n                // 错误重试\n                this.scheduleOnce(()=>{\n                    this.loadAB(cb, version)\n                }, 3)\n            }\n        });\n    },\n\n    // 下载资源\n    preloadModule(onProgress, onComplete){\n        let is_Valid = true\n\n        //---------------------------------------------------------\n        let autoAtlas = []\n        let resMap = this._abObj._config.assetInfos._map\n        for(let idx in resMap){\n            let item = resMap[idx]\n            if(!item.path && item.nativeVer){\n                let urll = cc.assetManager.utils.getUrlWithUuid(item.uuid, {\n                    __nativeName__: \".png\",\n                    nativeExt: cc.path.extname(\".png\"),\n                    isNative: true\n                }); \n                if(urll){\n                    autoAtlas.push(urll)\n                }\n            }\n        }\n\n        JS_LOG(\"autoatlas_url_arr_:\", JSON.stringify(autoAtlas))\n        let extNum = autoAtlas.length \n        let finishNum = 0\n        let is_2Valid = true\n        let preloadAutoAtlas = ()=>{\n            if(autoAtlas.length == 0 ){ \n                if(!is_2Valid){ return; }; is_2Valid = false ;\n                onComplete && onComplete();\n                return \n            }\n\n            // RequestType.URL = 'url' \n            cc.assetManager.preloadAny(autoAtlas, { __requestType__: 'url', type: null, bundle: this._abObj.name }, \n                (finish, total, item)=>{\n                    if(!is_2Valid){ return; }; \n                    JS_LOG(\"load_autoatlas_progress_:\",this._abObj.name, finish, total )\n                    onProgress && onProgress(finish+finishNum, total+finishNum, item);\n                }, (error, items)=>{\n                    if(!is_2Valid){ return; }; is_2Valid = false ;\n                    if(!error){\n                        onComplete && onComplete();\n                    }else { \n                        JS_LOG(\"preloadAutoAtlas_error:\", JSON.stringify(error) )\n                        this.scheduleOnce(()=>{\n                            this.preloadModule(onProgress, onComplete);\n                        }, 3)\n                    }\n                }   \n            );\n                \n        }\n        //--------------------------------------------------------- \n\n        this._abObj.preloadDir(\"root\", (finish, total, item)=>{\n            if(!is_Valid){ return; };\n            finishNum = total\n            onProgress && onProgress(finish, total + extNum, item);\n        }, (error, items)=>{\n            if(!is_Valid){ return; }; is_Valid = false ;\n            if(!error){\n                // onComplete && onComplete(items);\n                preloadAutoAtlas()\n            }else {\n                this.scheduleOnce(()=>{\n                    this.preloadModule(onProgress, onComplete);\n                }, 3)\n            }\n        })\n\n    },\n\n    releaseAB(){\n        this.unscheduleAllCallbacks();\n        if(!this._abObj ){ return }\n        JS_LOG(\"release_ab__\") \n        cc.assetManager.removeBundle(this._abObj);\n        this._abObj = null\n    },\n\n});\n\n"]}