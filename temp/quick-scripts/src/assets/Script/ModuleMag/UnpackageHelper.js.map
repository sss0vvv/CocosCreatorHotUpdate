{"version":3,"sources":["assets/Script/ModuleMag/UnpackageHelper.js"],"names":["ModuleConst","require","JS_LOG","arg","cc","log","Class","Component","properties","onLoad","_moduleMag","getComponent","_ModuleCom","_HotUIHelper","initCom","args","execUnpackage","onComplete","sys","os","OS_ANDROID","OS_IOS","OS_WINDOWS","localClientVer","localStorage","getItem","writablePath","jsb","fileUtils","getWritablePath","path_cache","_Gloabal","Client_Version","isFileExist","nativeRoot","getNativePath","path_native","isDirectoryExist","setItem","cacheMag","assetManager","cacheManager","coverCachelist","fileStr","getStringFromFile","abVersion","cache_d_Map","JSON","parse","files","id","info","cacheFile","url","bundle","indexOf","splitRet","split","length","stringify","writeCacheFile","setLocalAbVersion","unpackageShow","copyFoldTo","finish","total","unpackageUpdateProgress","unpackageFinish","getFileListFromDir","dir","filelist","co","cacheJson","cacheMap","item","fullpath","push","console","listFilesRecursively","oriRoot","copyTo","onProgress","onComplate","eachFrameCopyNum","realFileArr","i","path","substr","totalLen","curMisIndex","schHandler","unschedule","subPath","fileName","lastIndexOf","targetPath","newFold","createDirectory","fileData","getDataFromFile","saveRet","writeDataToFile","schedule"],"mappings":"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","sourceRoot":"/","sourcesContent":["\n\nlet ModuleConst = require(\"ModuleConst\")\n// let UnpackageHelper = require(\"UnpackageHelper\")\nlet JS_LOG = function(...arg){ \n    cc.log(\"[UnpackageHelper]\",...arg) ; \n}\n\ncc.Class({\n    \n    extends: cc.Component,\n    properties: {   \n\n    },\n\n    \n    onLoad(){\n        this._moduleMag = this.getComponent(\"ModuleManager\")\n        this._ModuleCom = this.getComponent(\"ModuleCom\")\n        this._HotUIHelper = this.getComponent(\"HotUIHelper\") \n    },\n\n\n    initCom(args){\n        // let {  } = args     \n\n    },\n\n    execUnpackage(onComplete){\n\n        if ( !(cc.sys.os == cc.sys.OS_ANDROID || cc.sys.os == cc.sys.OS_IOS || cc.sys.os == cc.sys.OS_WINDOWS) ) {\n            JS_LOG(\"ignore_unpackage\")\n            onComplete();\n            return \n        } \n\n        let localClientVer = cc.sys.localStorage.getItem(ModuleConst.localClientVer)\n        let writablePath = jsb.fileUtils.getWritablePath() \n        let path_cache  = writablePath + \"gamecaches/\" \n        \n        if( _Gloabal.Client_Version == localClientVer && jsb.fileUtils.isFileExist(path_cache+\"cacheList.json\")){\n            JS_LOG(\"Unpackage_not_exec\")\n            onComplete()\n            return ; \n\n        }else { \n            // 第一次启动该版本\n            let nativeRoot = this._moduleMag.getNativePath() //  \n\n            let path_native = nativeRoot + \"PKgamecaches/\"\n            JS_LOG(\"unpackage_res_:\", path_native, path_cache )\n\n            if(!jsb.fileUtils.isDirectoryExist(path_native)){\n                JS_LOG(\"PKgamecaches_not_exist\")\n                cc.sys.localStorage.setItem(ModuleConst.localClientVer, _Gloabal.Client_Version )\n                onComplete()\n                return ; \n            }\n            //-------------------------------------------------->>  替换 cacheManager 数据\n            let cacheMag = cc.assetManager.cacheManager\n            // cacheMag.clearCache()\n\n            let coverCachelist = ()=>{\n                let fileStr = jsb.fileUtils.getStringFromFile(path_native + \"cacheList.json\")  \n                \n                let abVersion = {} \n\n                var cache_d_Map = JSON.parse(fileStr)\n                if(cache_d_Map){\n                    let files = cache_d_Map.files\n                    for(let id in  files){\n                        let info = files[id]\n                        // JS_LOG(\"call_cacheFile_:\", id, info.url, info.bundle )\n                        cacheMag.cacheFile(id, info.url, info.bundle)\n\n                        // 查找版本号\n                        if(id.indexOf(\"/index.\") != -1){\n                            let splitRet = id.split('.')\n                            abVersion[info.bundle] = splitRet[splitRet.length-2]\n                        }\n                    }\n                }\n\n                // 覆盖本地资源版本号 \n                JS_LOG(\"abVersion__:\", JSON.stringify(abVersion) )\n\n                cacheMag.writeCacheFile(()=>{\n\n                    JS_LOG(\"writeCache_File_ok\")\n\n                    this._moduleMag.setLocalAbVersion(abVersion)\n\n\n                    cc.sys.localStorage.setItem(ModuleConst.localClientVer, _Gloabal.Client_Version )\n                    onComplete()\n                })\n            }\n            //--------------------------------------------------<<  替换 cacheManager 数据\n\n            this._HotUIHelper.unpackageShow()\n            this.copyFoldTo(path_native, path_cache, (finish, total)=>{\n                this._HotUIHelper.unpackageUpdateProgress(finish, total)\n                // JS_LOG(\"copy_file_:\", finish, total)\n            },()=>{\n                // 完成 \n                this._HotUIHelper.unpackageFinish()  \n                coverCachelist()\n            })\n        }\n\n\n    },\n\n\n    getFileListFromDir(dir, filelist){\n        let co = 1\n        if(cc.sys.os == cc.sys.OS_ANDROID){\n            let cacheJson = jsb.fileUtils.getStringFromFile(dir + \"cacheList.json\")\n            let cacheMap = JSON.parse(cacheJson)\n            let files = cacheMap.files\n            for(let url in files){\n                let item = files[url]\n                let fullpath = this._moduleMag.getNativePath()+\"PKgamecaches/\"+item.url\n                filelist.push(fullpath)\n                if(co<3){\n                    console.log(\"get_file_list_full_:\", fullpath )\n                }\n                co = co+1\n            } \n        }else {\n            jsb.fileUtils.listFilesRecursively(dir, filelist)\n        } \n    },\n\n    // 拷贝文件夹到 copyFoldTo(\"/path1/src/\", \"/path2/src/\") \n    copyFoldTo(oriRoot, copyTo, onProgress, onComplate){\n\n        let eachFrameCopyNum = 5  // 每帧复制文件数\n\n        if( (typeof(jsb)==\"undefined\") || !jsb.fileUtils.isDirectoryExist(oriRoot)){\n            cc.log(\"ori_folder_not_exist_:\", oriRoot )\n            onComplate();\n            return \n        }\n\n        let filelist = []\n        this.getFileListFromDir(oriRoot, filelist) \n\n        cc.log(\"file_ori_arr_:\",oriRoot, filelist.length);\n\n        let realFileArr = []\n        for(let i=0;i<filelist.length;i++){\n            let path = filelist[i]\n            if(path.substr( path.length-1 )!=\"/\"){\n                realFileArr.push(path)\n            } \n        }\n\n        let totalLen = realFileArr.length\n\n        if(totalLen==0){\n            cc.log(\"totalLen_is_0:\", oriRoot )\n            onComplate();\n            return ;\n        }\n\n        let curMisIndex = 0\n\n        let schHandler = \"\"\n        schHandler = ()=>{\n\n            for(let i=curMisIndex; i<curMisIndex+eachFrameCopyNum; i++){ \n\n                if(i>=totalLen){\n                    this.unschedule(schHandler)\n                    onComplate()\n                    return ;\n                }\n                let path = realFileArr[i] \n    \n                let subPath = path.substr( oriRoot.length )  // 后半部分路径 import/00/00.7871f.json\n                let fileName = path.substr( path.lastIndexOf(\"\\/\")+1) // 文件名 00.7871f.json\n                let targetPath = copyTo + subPath // 目标完整路径\n                let newFold = targetPath.substr( 0, targetPath.lastIndexOf(\"\\/\")+1 ) // 目标文件夹\n    \n                if(!jsb.fileUtils.isDirectoryExist(newFold)){ // 文件夹不存在则创建 \n                    jsb.fileUtils.createDirectory(newFold)\n                }\n\n                let fileData = jsb.fileUtils.getDataFromFile(path); \n                let saveRet = jsb.fileUtils.writeDataToFile(fileData, targetPath);\n                if(!saveRet){\n\n                    this.unschedule(schHandler)\n                    return ;\n                }  \n                \n            } \n            curMisIndex = curMisIndex + eachFrameCopyNum\n\n            onProgress( (curMisIndex<=totalLen? curMisIndex : totalLen), totalLen)\n\n        }\n        this.schedule(schHandler, 0)\n\n    },\n\n});\n"]}